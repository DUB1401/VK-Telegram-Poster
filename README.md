# VK-Telegram Poster
**VK-Telegram Poster** – это инструмент автопостинга записей из сообщества ВКонтакте в каналы и группы Telegram с возможностью настройки пользовательского скрипта обработки постов. 

Для отправки сообщений используется буфер ожидания, что позволяет автопостеру корректно работать с включённым медленным режимом группы (чтобы игнорировать медленный режим или отправлять сообщения в канал, бот должен иметь права администратора).

Автопостер поддерживает пересылку следующих типов вложений: _doc_, _photo_, _video_. Подробнее [здесь](https://dev.vk.com/reference/objects/attachments-wall).

## Порядок установки и использования
1. Загрузить последний релиз. Распаковать.
2. Установить Python версии не старше 3.10.
3. В среду исполнения установить следующие пакеты: [dublib](https://github.com/DUB1401/dublib), [pyTelegramBotAPI](https://github.com/eternnoir/pyTelegramBotAPI), [fastapi](https://github.com/tiangolo/fastapi), [uvicorn](https://github.com/encode/uvicorn).
```
pip install git+https://github.com/DUB1401/dublib#egg=dublib
pip install pyTelegramBotAPI
pip install fastapi
pip install uvicorn
```
Либо установить сразу все пакеты при помощи следующей команды, выполненной из директории скрипта.
```
pip install -r requirements.txt
```
4. Создать в папке _Config_ файл конфигурации по предоставленному примеру (см. [здесь](#конфигурация-источника)).
5. Настроить автопостер путём редактирования _Settings.json_. Для добавления пользовательского скрипта обработки постов можно внести изменения в файл _MessageEditor.py_.
6. При необходимости, например в случае использования скрипта на хостинге активного сайта, настроить переадресацию [nginx](https://nginx.org/) на свободный порт.
7. Провести валидацию сервера согласно данному [руководству](https://dev.vk.com/api/callback/getting-started#%D0%9F%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5%20Callback%20API). Код подтверждения перед верификацией занести в файл настроек _Settings.json_.
8. Открыть директорию со скриптом в терминале. Можно использовать метод `cd` и прописать путь к папке, либо запустить терминал из проводника. Активировать автопостер командой `uvicorn vtp:App --host {IP} --port {PORT}`.
9. Для автоматического запуска службы рекомендуется провести инициализацию скрипта через [systemd](https://github.com/systemd/systemd) (пример [здесь](https://github.com/DUB1401/VK-Telegram-Poster/tree/main/systemd)) на Linux или путём добавления его в автозагрузку на Windows.

## Версии поставляемых бинарных файлов
| Файл    | Версия                        | Источник                                                           |
|---------|-------------------------------|--------------------------------------------------------------------|
| yt-dlp  | _2023.07.06_                  | [ссылка](https://github.com/yt-dlp/yt-dlp/releases/tag/2023.07.06) |

# Конфигурация источника
Для добавления новой конфигурации создайте копию файла _Example.json_ и переименуйте её согласно источнику. Источник указывает конечную часть URI, использующегося для прослушивания Callback-запросов. 

**Пример:** `{HOST}/vtp/{SOURCE}`
___
```JSON
"token": ""
```
Сюда необходимо занести токен бота Telegram (можно получить у [BotFather](https://t.me/BotFather)). Токен должен быть уникальным для каждого источника.
___
```JSON
"target": ""
```
Сюда необходимо занести ID группы или канала Telegram (можно получить у [Chat ID Bot](https://t.me/chat_id_echo_bot)).
___
```JSON
"clean-tags": true
```
Если включено, скрипт будет удалять упоминания из тегов ВКонтакте (_#tag@mention_ → _#tag_). Рекомендуется к активации, так как Telegram не поддерживает подобный формат.
___
```JSON
"parse-mode": null
```
Указывает способ форматирования сообщения, отправляемого в группу Telegram. 

Поддерживаются: _MarkdownV2_, _HTML_.
___
```JSON
"disable-web-page-preview": true
```
Если включено, ссылки из сообщения, в том числе форматированные, не будут отображаться в предпросмотре под данным сообщением.
___
```JSON
"blacklist": []
```
Здесь можно перечислить запрещённые слова, при наличии которых пост будет игнорироваться. Настройка нечувствительна к регистру.
___
```JSON
"attachments": {
	"doc": true,
	"photo": true,
	"video": true
}
```
В данной секции можно указать, какие типы вложений требуется пересылать в Telegram.

> [!IMPORTANT]  
> Для пересылки _video_ необходимо, чтобы в сообществе ВКонтакте для раздела «Видео» было установленно значение _Открытые_ или _Ограниченные_.

# Settings.json
```JSON
"confirmation-code": ""
```
Указывает код подтверждения, необходимый для валидации прослушивающего сервера.
___
```JSON
"logging": false
```
Если включено, скрипт будет вести логи инициализации и прослушивания запросов.
___
```JSON
"debug": false
```
Включает отладочный режим логгирования.

# Благодарность
* [@yt-dlp](https://github.com/yt-dlp) – библиотека загрузки видео из ВКонтакте.

_Copyright © DUB1401. 2022-2023._
