# VK-Telegram Poster
**VK-Telegram Poster** – это инструмент автопостинга записей из сообществ ВКонтакте в каналы и группы Telegram с возможностью настройки пользовательского скрипта обработки постов. Поддерживается как [Callback API](https://dev.vk.com/ru/api/callback/getting-started), так и [LongPoll API](https://dev.vk.com/ru/api/user-long-poll/getting-started).

Для отправки сообщений используется буфер ожидания, что позволяет автопостеру корректно работать с включённым медленным режимом группы (чтобы игнорировать медленный режим или отправлять сообщения в канал, бот должен иметь права администратора). Также в скрипт внедрена возможность автоматического решения каптчи с использованием AI-сервисов.

Автопостер поддерживает пересылку следующих типов вложений: _doc_, _photo_, _video_. Подробнее [здесь](https://dev.vk.com/reference/objects/attachments-wall).

## Порядок установки и использования | Callback API
1. Загрузить последний релиз. Распаковать.
2. Установить Python версии не старше 3.10.
3. В среду исполнения установить следующие пакеты: [dublib](https://github.com/DUB1401/dublib), [pyTelegramBotAPI](https://github.com/eternnoir/pyTelegramBotAPI), [onnxruntime](https://github.com/microsoft/onnxruntime), [vk_captcha](https://github.com/imartemy1524/vk_captcha), [fastapi](https://github.com/tiangolo/fastapi), [uvicorn](https://github.com/encode/uvicorn), [vk_api](https://github.com/python273/vk_api).
```
pip install git+https://github.com/DUB1401/dublib.git
pip install pyTelegramBotAPI
pip install onnxruntime
pip install vk_captcha
pip install fastapi
pip install uvicorn
pip install vk_api
```
Либо установить сразу все пакеты при помощи следующей команды, выполненной из директории скрипта.
```
pip install -r requirements.txt
```
4. Создать в папке _Config_ файл конфигурации по предоставленному примеру (см. [здесь](#конфигурация-источника)).
5. Настроить автопостер путём редактирования _Settings.json_. Для добавления пользовательского скрипта обработки постов можно внести изменения в файл _MessageEditor.py_.
6. При необходимости, например в случае использования скрипта на хостинге активного сайта, настроить переадресацию [nginx](https://nginx.org/) на свободный порт.
7. Провести валидацию сервера согласно данному [руководству](https://dev.vk.com/api/callback/getting-started#%D0%9F%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5%20Callback%20API). Код подтверждения перед верификацией занести в файл настроек _Settings.json_.
8. Открыть директорию со скриптом в терминале. Можно использовать метод `cd` и прописать путь к папке, либо запустить терминал из проводника. Активировать автопостер командой `uvicorn vtp:App --host {IP} --port {PORT}`.
9. Для автоматического запуска службы рекомендуется провести инициализацию скрипта через [systemd](https://github.com/systemd/systemd) (пример [здесь](https://github.com/DUB1401/VK-Telegram-Poster/tree/main/systemd)) на Linux или путём добавления его в автозагрузку на Windows.

## Порядок установки и использования | LongPoll API
1. Загрузить последний релиз. Распаковать.
2. Установить Python версии не старше 3.10.
3. В среду исполнения установить следующие пакеты: [dublib](https://github.com/DUB1401/dublib), [pyTelegramBotAPI](https://github.com/eternnoir/pyTelegramBotAPI), [onnxruntime](https://github.com/microsoft/onnxruntime), [vk_captcha](https://github.com/imartemy1524/vk_captcha), [fastapi](https://github.com/tiangolo/fastapi), [uvicorn](https://github.com/encode/uvicorn), [vk_api](https://github.com/python273/vk_api).
```
pip install git+https://github.com/DUB1401/dublib.git
pip install pyTelegramBotAPI
pip install onnxruntime
pip install vk_captcha
pip install fastapi
pip install uvicorn
pip install vk_api
```
Либо установить сразу все пакеты при помощи следующей команды, выполненной из директории скрипта.
```
pip install -r requirements.txt
```
4. Создать в папке _Config_ файл конфигурации по предоставленному примеру (см. [здесь](#longpoll-api)).
5. Настроить автопостер путём редактирования _Settings.json_. Указываемый аккаунт [ВКонтакте](https://vk.com/) должен иметь отключённую двухфакторную аутентификацию.
6. Для добавления пользовательского скрипта обработки постов можно внести изменения в файл _MessageEditor.py_.
7. Открыть директорию со скриптом в терминале. Можно использовать метод `cd` и прописать путь к папке, либо запустить терминал из проводника. Активировать автопостер командой `uvicorn vtp:App` (если используются оба типа API, тогда в качестве аргументов команде необходимо задать IP и порт по аналогии с [этим](#порядок-установки-и-использования--callback-api) руководством).
8. Для автоматического запуска службы рекомендуется провести инициализацию скрипта через [systemd](https://github.com/systemd/systemd) (пример [здесь](https://github.com/DUB1401/VK-Telegram-Poster/tree/main/systemd)) на Linux или путём добавления его в автозагрузку на Windows.

## Версии поставляемых бинарных файлов
| Файл    | Версия                        | Источник                                                           |
|---------|-------------------------------|--------------------------------------------------------------------|
| yt-dlp  | _2023.07.06_                  | [ссылка](https://github.com/yt-dlp/yt-dlp/releases/tag/2023.07.06) |

# Конфигурация источника
Сервис предоставляет поддержку как [Callback API](https://dev.vk.com/ru/api/callback/getting-started), так и [LongPoll API](https://dev.vk.com/ru/api/user-long-poll/getting-started). Ниже приведено их сравнение.

| Признак           | Callback API                                                             | LongPoll API                                                                               |
|-------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------------------------|
| Тип запросов      | Запросы отправляет сервер [ВКонтакте](https://vk.com/) по заданному URL. | Скрипт сам отправляет запросы к серверам [ВКонтакте](https://vk.com/) и получает ответ.    |
| Требуемые права   | Для верификации сервера требуются права администратора в сообществе.     | Права администратора не требуются.                                                         |
| Скорость отправки | Посты пересылаются практически моментально.                              | Посты запрашиваются с определённым интервалом, не менее 1 минуты.                          |
| Особенности       | Часто требуется дополнительная настройка [nginx](https://nginx.org/).    | Требуется аккаунт [ВКонтакте](https://vk.com/) с отключённой двухфакторной аутентификацией.|

> [!IMPORTANT]  
> Для пересылки вложений типа _video_ необходимо, чтобы в сообществе [ВКонтакте](https://vk.com/) для раздела «Видео» было установленно значение _Открытые_ или _Ограниченные_.

## Callback API
Для добавления новой конфигурации создайте копию файла _# Callback API Example.json_ и переименуйте её согласно источнику. Источник указывает конечную часть URI, использующегося для прослушивания Callback-запросов. 

**Пример:** `{HOST}/vtp/{SOURCE}`
___
```JSON
"api": "Callback"
```
Указывает тип используемого API.
___
```JSON
"token": ""
```
Сюда необходимо занести токен бота Telegram (можно получить у [BotFather](https://t.me/BotFather)). Токен должен быть уникальным для каждого источника.
___
```JSON
"target": ""
```
Сюда необходимо занести ID группы или канала Telegram (можно получить у [Chat ID Bot](https://t.me/chat_id_echo_bot)).
___
```JSON
"clean-tags": true
```
Если включено, скрипт будет удалять упоминания из тегов ВКонтакте (_#tag@mention_ → _#tag_). Рекомендуется к активации, так как Telegram не поддерживает подобный формат.
___
```JSON
"parse-mode": null
```
Указывает способ форматирования сообщения, отправляемого в группу Telegram. 

Поддерживаются: _MarkdownV2_, _HTML_.
___
```JSON
"disable-web-page-preview": true
```
Если включено, ссылки из сообщения, в том числе форматированные, не будут отображаться в предпросмотре под данным сообщением.
___
```JSON
"blacklist": []
```
Здесь можно перечислить запрещённые слова, при наличии которых пост будет игнорироваться. Настройка нечувствительна к регистру.
___
```JSON
"attachments": {
	"doc": true,
	"photo": true,
	"video": true
}
```
В данной секции можно указать, какие типы вложений требуется пересылать в Telegram.

## LongPoll API
Для добавления новой конфигурации создайте копию файла _# LongPoll API Example.json_ и переименуйте её. Имя файла может быть любым, но рекомендуется использовать только латинские буквы.
___
```JSON
"api": "LongPoll"
```
Указывает тип используемого API.
___
```JSON
"token": ""
```
Сюда необходимо занести токен бота Telegram (можно получить у [BotFather](https://t.me/BotFather)). Токен должен быть уникальным для каждого источника.
___
```JSON
"target": ""
```
Сюда необходимо занести ID группы или канала Telegram (можно получить у [Chat ID Bot](https://t.me/chat_id_echo_bot)).
___
```JSON
"wall-id": 0
```
Сюда необходимо занести ID сообщества [ВКонтакте](https://vk.com/). Быстро узнать его можно при помощи этого [сайта](https://regvk.com/id/).
___
```JSON
"clean-tags": true
```
Если включено, скрипт будет удалять упоминания из тегов ВКонтакте (_#tag@mention_ → _#tag_). Рекомендуется к активации, так как Telegram не поддерживает подобный формат.
___
```JSON
"parse-mode": null
```
Указывает способ форматирования сообщения, отправляемого в группу Telegram. 

Поддерживаются: _MarkdownV2_, _HTML_.
___
```JSON
"disable-web-page-preview": true
```
Если включено, ссылки из сообщения, в том числе форматированные, не будут отображаться в предпросмотре под данным сообщением.
___
```JSON
"blacklist": []
```
Здесь можно перечислить запрещённые слова, при наличии которых пост будет игнорироваться. Настройка нечувствительна к регистру.
___
```JSON
"attachments": {
	"doc": true,
	"photo": true,
	"video": true
}
```
В данной секции можно указать, какие типы вложений требуется пересылать в Telegram.
___
```JSON
"last-post-id": null
```
Сюда скрипт заносит ID последнего пересланного поста. Не рекомендуется вручную изменять это значение, если вы не уверены в том, что делаете.

# Settings.json
```JSON
"login": ""
```
Логин аккаунта [ВКонтакте](https://vk.com/).
___
```JSON
"password": ""
```
Пароль аккаунта [ВКонтакте](https://vk.com/).
___
```JSON
"app-id": 2685278
```
Указывает ID приложения для доступа к API. Если у вас не работает авторизация, рекомендуется сменить его.
___
```JSON
"longpoll-period": 60
```
Задаёт интервал запросов для [LongPoll API](https://dev.vk.com/ru/api/user-long-poll/getting-started) в минутах.
___
```JSON
"confirmation-code": ""
```
Указывает код подтверждения, необходимый для валидации прослушивающего сервера.
___
```JSON
"logging": true
```
Если включено, скрипт будет вести логи инициализации и прослушивания запросов.
___
```JSON
"debug": false
```
Включает отладочный режим логгирования.

# Благодарность
* [@yt-dlp](https://github.com/yt-dlp) – библиотека загрузки потокового видео;
* [@python273](https://github.com/python273/vk_api) – имплементация API [ВКонтакте](https://vk.com/).

_Copyright © DUB1401. 2022-2023._
